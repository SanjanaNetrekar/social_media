<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Users â€¢ InstaLite</title><link rel="stylesheet" href="style.css"></head>
<body>
<header class="topbar small"><div class="top-inner"><div class="left"><div class="logo-square">IL</div><div class="app-title">InstaLite</div></div><div class="right"><button class="icon" onclick="location.href='feed.html'">Feed</button></div></div></header>

<main style="max-width:1200px;margin:18px auto;padding:0 12px;">
  <div class="card">
    <h3>All users</h3>
    <div style="margin-top:12px">
      <input id="userSearch" class="input" placeholder="Search users..." oninput="onUserSearch()">
    </div>
    <div id="userGrid" class="users-grid" style="margin-top:16px;display:grid;grid-template-columns:repeat(4,1fr);gap:16px"></div>
  </div>
</main>

<script>
const API = 'http://localhost:3000';
const DEFAULT_AV = '/mnt/data/a2ec838d-f32b-43e1-8b47-ff7434b1674c.png';
let allUsers = [];

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

async function loadUsers(){
  const grid = document.getElementById('userGrid'); grid.innerHTML = '<div class="card muted center">Loading...</div>';
  try{
    const r = await fetch(API + '/users'); if(!r.ok){ grid.innerHTML = '<div class="card muted">Failed to load users</div>'; return; }
    allUsers = await r.json();
    renderGrid(allUsers);
  }catch(err){ console.error('loadUsers',err); grid.innerHTML = '<div class="card muted">Error loading users</div>'; }
}
function renderGrid(users){
  const grid = document.getElementById('userGrid'); grid.innerHTML = '';
  if(!users || users.length===0){ grid.innerHTML = '<div class="card muted center">No users</div>'; return; }
  users.forEach(u=>{
    const avatar = u.avatar || DEFAULT_AV;
    const id = u.id || u.user_id || 0;
    const div = document.createElement('div'); div.className='user-card'; div.style.padding='14px'; div.style.textAlign='center'; div.style.borderRadius='12px';
    div.innerHTML = `<div style="cursor:pointer" onclick="viewProfile(${id})"><img src="${escapeHtml(avatar)}" width="120" height="120" style="object-fit:cover;border-radius:18px" onerror="this.src='${DEFAULT_AV}'"></div>
      <div style="font-weight:800;margin-top:8px">${escapeHtml(u.name||u.email||'User')}</div>
      <div class="muted small" style="margin-bottom:8px">${escapeHtml(u.email||'')}</div>
      <div style="display:flex;justify-content:center;gap:8px"><button class="btn ghost" onclick="viewProfile(${id})">View</button><button class="btn ghost" onclick="startChat(event, ${id}, '${(u.name||'').replace(/'/g,"\\'")}', '${(u.avatar||'').replace(/'/g,"\\'")}')">Chat</button></div>`;
    grid.appendChild(div);
  });
}

function viewProfile(id){ location.href='profile.html?id='+id; }
function startChat(e, id, name, avatar){ if(e) e.stopPropagation(); localStorage.setItem('chatWith', JSON.stringify({id,name,avatar})); location.href='messages.html'; }

function onUserSearch(){ const q = (document.getElementById('userSearch').value||'').trim().toLowerCase(); if(!q) return renderGrid(allUsers); const filtered = allUsers.filter(u => (u.name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q)); renderGrid(filtered); }

loadUsers();
</script>
</body>
</html>
