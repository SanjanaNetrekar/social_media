<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Profile â€¢ InstaLite</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    header{padding:14px 22px;background:linear-gradient(90deg,#00b4ff,#7a3cff);color:#fff;display:flex;align-items:center;justify-content:space-between}
    .container{max-width:980px;margin:22px auto;padding:8px}
    .card{background:#fff;border-radius:12px;padding:18px;box-shadow:0 10px 40px rgba(10,10,10,0.06);margin-bottom:18px}
    .avatar-lg{width:120px;height:120px;border-radius:14px;object-fit:cover}
    .muted{color:#666}
    .follow-btn{padding:8px 12px;border-radius:12px;border:1px solid rgba(0,0,0,0.08);cursor:pointer}
    .follow-btn.following{background:#111;color:#fff;border-color:transparent}
    .small{font-size:12px}
    .post-card { margin-bottom:12px; padding:12px; border-radius:8px; border:1px solid rgba(0,0,0,0.04); }
    .delete-btn{background:transparent;border:0;color:#b00;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;gap:12px;align-items:center">
      <div style="width:44px;height:44px;background:#fff;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#7a3cff;font-weight:800">IL</div>
      <div style="font-weight:800">InstaLite</div>
    </div>
    <div><button onclick="location.href='feed.html'" style="padding:8px 12px;border-radius:8px">Feed</button></div>
  </header>

  <main class="container">
    <div id="profileCard" class="card">Loading profile...</div>

    <div id="postsCard" class="card">
      <div style="font-weight:700;margin-bottom:12px">Posts</div>
      <div id="profilePosts">Loading...</div>
    </div>
  </main>

<script>
const API = 'http://localhost:3000';
const DEFAULT_AV = '/mnt/data/a2ec838d-f32b-43e1-8b47-ff7434b1674c.png';

function q(name){ return new URL(location.href).searchParams.get(name); }
function esc(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

let me = null;
try{ me = JSON.parse(localStorage.getItem('user') || 'null'); }catch(e){ me = null; }
let viewedUser = null;

function extractPostUserId(post){
  if(!post) return null;
  if(post.user_id) return String(post.user_id);
  if(post.userId) return String(post.userId);
  if(post.author_id) return String(post.author_id);
  if(post.authorId) return String(post.authorId);
  if(post.posted_by) return String(post.posted_by);
  if(post.user && (post.user.id || post.user._id)) return String(post.user.id || post.user._id);
  if(post.author && (post.author.id || post.author._id)) return String(post.author.id || post.author._id);
  if(post.owner && (post.owner.id || post.owner._id)) return String(post.owner.id || post.owner._id);
  if(typeof post.user === 'string') return post.user;
  return String(post.user_id || post.user || post.author || post.id || '');
}

function renderProfileUI(user){
  viewedUser = user;
  const wrap = document.getElementById('profileCard');
  const avatar = user.avatar || user.image || DEFAULT_AV;
  const name = user.name || user.username || user.fullname || user.email || 'Unknown';
  const email = user.email || '';
  const followers = Number(user.followers_count || user.followers || 0);
  const following = Number(user.following_count || user.following || 0);

  wrap.innerHTML = `
    <div style="display:flex;gap:18px;align-items:center">
      <img id="profileAvatar" src="${esc(avatar)}" class="avatar-lg" onerror="this.src='${DEFAULT_AV}'">
      <div style="flex:1">
        <div style="font-weight:800;font-size:20px" id="profileName">${esc(name)}</div>
        <div class="muted small" id="profileEmail">${esc(email)}</div>
        <div style="display:flex;gap:20px;margin-top:12px">
          <div><strong id="followersCount">${esc(followers)}</strong><div class="muted small">Followers</div></div>
          <div><strong id="followingCount">${esc(following)}</strong><div class="muted small">Following</div></div>
        </div>
        <div style="margin-top:12px">
          <button id="followBtn" class="follow-btn">Follow</button>
          <button id="editBtn" style="margin-left:8px;padding:8px 12px;border-radius:10px">Edit profile</button>
        </div>
      </div>
    </div>
    <div style="margin-top:12px;color:#666" id="profileNote">Profile loaded</div>
    <div style="margin-top:10px" id="profileBio">${esc(user.bio||'')}</div>
  `;

  const editBtn = document.getElementById('editBtn');
  const followBtn = document.getElementById('followBtn');

  if(me && String(me.id) === String(user.id)){
    followBtn.style.display = 'none';
    editBtn.onclick = ()=> location.href = 'edit-profile.html?id=' + encodeURIComponent(user.id);
  } else {
    editBtn.style.display = 'none';
    followBtn.style.display = 'inline-block';
    let isFollowing = false;
    try{ const map = JSON.parse(localStorage.getItem('following_' + (me?me.id:'anon')) || '{}'); isFollowing = !!map[String(user.id)]; }catch(e){}
    setFollowButtonState(followBtn, isFollowing);
    followBtn.onclick = ()=> toggleFollow(user.id, followBtn);
  }
}

function setFollowButtonState(btn, following){
  if(following){ btn.classList.add('following'); btn.innerText = 'Following'; }
  else { btn.classList.remove('following'); btn.innerText = 'Follow'; }
}

async function loadProfile(){
  const id = q('id');
  const wrap = document.getElementById('profileCard');
  const postsHolder = document.getElementById('profilePosts');
  if(!id){ wrap.innerText = 'Profile id missing in URL.'; postsHolder.innerText=''; return; }

  try{
    const local = JSON.parse(localStorage.getItem('user') || 'null');
    if(local && String(local.id) === String(id)){
      renderProfileUI(local);
    }
  }catch(e){}

  const tries = [
    API + '/users/' + id,
    API + '/user/' + id,
    API + '/users?id=' + id,
    API + '/profile?id=' + id,
    API + '/getUser?id=' + id
  ];

  let user = null;
  for(const url of tries){
    try{
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) continue;
      const j = await res.json();
      if(Array.isArray(j) && j.length) user = j[0];
      else if(j.user) user = j.user;
      else if(j.data && (Array.isArray(j.data)? j.data[0] : true)) user = Array.isArray(j.data)? j.data[0] : j.data;
      else if(j.profile) user = j.profile;
      else user = j;
      if(user && (user.id || user.email || user.name)) break;
      user = null;
    }catch(e){ continue; }
  }

  if(!user){
    const local = JSON.parse(localStorage.getItem('user') || 'null');
    if(local && String(local.id) === String(id)){
      renderProfileUI(local);
      loadPosts(id); return;
    }
    wrap.innerHTML = '<div style="color:#b00">Could not load profile from server. Showing offline fallback if available.</div>';
    postsHolder.innerText = ''; return;
  }

  renderProfileUI(user);
  loadPosts(user.id || id);
}

async function loadPosts(userId){
  const holder = document.getElementById('profilePosts'); holder.innerHTML = 'Loading posts...';
  const tries = [ API + '/posts?user_id=' + userId, API + '/posts/user/' + userId, API + '/userposts?id=' + userId, API + '/allposts' ];
  for(const url of tries){
    try{
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) continue;
      const j = await res.json();
      let posts = Array.isArray(j) ? j : (j.posts || j.data || []);
      // If endpoint returned all posts, filter using extractPostUserId
      if(url.endsWith('/allposts')){
        posts = (Array.isArray(posts)?posts:[]).filter(p => extractPostUserId(p) === String(userId));
      } else {
        // also allow nested user objects: filter defensively
        posts = (Array.isArray(posts)?posts:[]).filter(p => {
          const pid = extractPostUserId(p);
          return String(pid) === String(userId);
        });
      }

      if(!Array.isArray(posts)) posts = [];
      if(posts.length === 0){ holder.innerHTML = '<div class="muted">No posts yet</div>'; return; }
      holder.innerHTML = '';
      posts.sort((a,b)=> new Date(b.created_at||b.createdAt||0) - new Date(a.created_at||a.createdAt||0));
      posts.forEach(p => {
        const div = document.createElement('div'); div.className = 'post-card';
        const created = esc(new Date(p.created_at || p.createdAt || Date.now()).toLocaleString());
        const text = esc(p.content || p.text || '');
        const imgHtml = p.image_url ? `<div style="margin-top:8px"><img src="${esc(p.image_url)}" style="max-width:100%;border-radius:10px"></div>` : '';
        // show delete button if owner
        const authorId = extractPostUserId(p);
        const owner = me && String(me.id) === String(authorId);
        div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">${text}</div>${owner ? `<button class="delete-btn" onclick="profileDeletePost('${esc(p.id||p.post_id||p._id)}', this)">ðŸ—‘ Delete</button>` : ''}</div><div class="muted small">${created}</div>${imgHtml}`;
        holder.appendChild(div);
      });
      return;
    }catch(e){ console.warn('loadPosts try failed for', url, e); continue; }
  }
  holder.innerHTML = '<div class="muted">Could not load posts</div>';
}

async function profileDeletePost(postId, btnEl){
  if(!me) return alert('Please log in to delete posts');
  if(!confirm('Delete this post?')) return;
  // optimistic UI remove: remove parent .post-card
  const card = btnEl.closest('.post-card'); if(card) card.remove();
  try{
    let r = await fetch(API + '/deletepost/' + encodeURIComponent(postId), { method: 'DELETE' });
    if(r.ok) return;
    r = await fetch(API + '/deletepost', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id: postId, user_id: me.id }) });
    if(r.ok) return;
  }catch(e){ console.warn('profile delete failed', e); }
}

async function toggleFollow(targetId, btnEl){ if(!me) return alert('Please log in to follow users'); const key = 'following_' + me.id; const map = JSON.parse(localStorage.getItem(key) || '{}'); const isFollowing = !!map[String(targetId)]; if(isFollowing){ delete map[String(targetId)]; localStorage.setItem(key, JSON.stringify(map)); setFollowButtonState(btnEl, false); try{ await fetch(API + '/unfollow', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: me.id, target_id: targetId }) }); }catch(e){ console.warn('unfollow failed', e); } } else { map[String(targetId)] = true; localStorage.setItem(key, JSON.stringify(map)); setFollowButtonState(btnEl, true); try{ await fetch(API + '/follow', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: me.id, target_id: targetId }) }); }catch(e){ console.warn('follow failed', e); } } }

window.addEventListener('storage', (e) => {
  if(e.key === 'user' || (e.key && e.key.startsWith('following_')) || e.key === 'profile_updated_at'){ try{ me = JSON.parse(localStorage.getItem('user') || 'null'); }catch(e){} setTimeout(()=> loadProfile(), 200); }
});

loadProfile();
</script>
</body>
</html>
