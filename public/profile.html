<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Profile â€¢ InstaLite</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto;margin:0;background:linear-gradient(180deg,#fbfbfd,#f6f2fb)}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:18px 28px;background:linear-gradient(90deg,#06b6d4,#7c3aed);color:#fff}
    .wrap{width:92%;margin:24px auto;display:flex;gap:20px}
    .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(20,20,40,0.06)}
    .left{width:32%}.right{width:68%}
    .pv{display:flex;gap:16px;align-items:center}
    .pv img{width:120px;height:120px;border-radius:12px;object-fit:cover}
    .muted{color:#7b7b7b}
    .counts{display:flex;gap:22px;margin-top:8px}
    .counts div{cursor:pointer}
    .post-card{margin-top:14px;padding:12px;border-radius:10px}
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.3);display:none;align-items:center;justify-content:center;z-index:999}
    .modal{background:#fff;border-radius:10px;padding:12px;width:420px;max-height:80vh;overflow:auto}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .follow-btn{background:#f0f0f0}
    .follow-btn.following{background:#111;color:#fff}
    .small{font-size:12px;color:#7b7b7b}
  </style>
</head>
<body>

  <div class="topbar">
    <div style="font-weight:700">InstaLite</div>
    <div style="display:flex;gap:10px;align-items:center">
      <button class="btn" onclick="location.href='feed.html'">Feed</button>
      <button class="btn" onclick="location.href='users.html'">Users</button>
    </div>
  </div>

  <div class="wrap">
    <div class="left card">
      <div class="pv">
        <img id="profileAvatar" src="">
        <div>
          <div id="profileName" style="font-weight:800;font-size:20px"></div>
          <div id="profileEmail" class="muted"></div>
          <div class="counts" style="margin-top:10px">
            <div id="followersCount"><strong id="followersNum">0</strong><div class="small">Followers</div></div>
            <div id="followingCount"><strong id="followingNum">0</strong><div class="small">Following</div></div>
          </div>
          <div style="margin-top:14px">
            <button id="followBtn" class="btn follow-btn">Follow</button>
            <button id="editBtn" class="btn" style="display:none;background:#06b6d4;color:#fff" onclick="editProfile()">Edit profile</button>
          </div>
        </div>
      </div>

      <div style="margin-top:18px" id="profileBio">Profile loaded</div>
    </div>

    <div class="right card">
      <div style="font-weight:700">Posts</div>
      <div id="postsArea"></div>
    </div>
  </div>

  <div id="modalBackdrop" class="modal-back">
    <div class="modal" id="listModal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong id="modalTitle">Title</strong>
        <button onclick="closeModal()">Close</button>
      </div>
      <div id="modalList" style="margin-top:10px"></div>
    </div>
  </div>

<script>
  const API = "http://localhost:3000";
  const DEFAULT_AV = "/uploads/default-avatar.png";

  // reactive local user
  let me = null;
  try { me = JSON.parse(localStorage.getItem("user") || "null"); } catch(e){ me = null; }
  if(me && me.id) me.id = String(me.id);

  function q(name){ return new URLSearchParams(location.search).get(name); }
  function esc(s){ if(s===null||s===undefined) return ""; return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  // viewed user (profile being viewed)
  let viewedUser = null;

  // apply local user to profile UI if viewing our own profile
  function applyLocalUserToProfileUI(){
    if(!me) return;
    if(String(viewedUser?.id) === String(me.id)){
      const preview = document.getElementById("profileAvatar");
      const nameEl = document.getElementById("profileName");
      const emailEl = document.getElementById("profileEmail");
      if(preview) preview.src = me.avatar || preview.src || DEFAULT_AV;
      if(nameEl) nameEl.innerText = me.name || nameEl.innerText;
      if(emailEl) emailEl.innerText = me.email || emailEl.innerText;
    }
  }

  // merge server user and local copy (prefer server values but keep local avatar if present)
  function mergeAndStoreUser(serverUser){
    const local = (localStorage.getItem("user") && JSON.parse(localStorage.getItem("user"))) || {};
    const merged = Object.assign({}, serverUser, local);
    try { localStorage.setItem("user", JSON.stringify(merged)); } catch(e){}
    me = merged;
    applyLocalUserToProfileUI();
    return merged;
  }

  async function initProfile(){
    const id = q("id");
    if(!id){ alert("Missing profile id"); location.href = "feed.html"; return; }

    try{
      const r = await fetch(API + "/users");
      if(!r.ok) throw new Error("Could not load users list");
      const users = await r.json();
      const found = users.find(u => String(u.id) === String(id));
      if(!found){
        if(String(me?.id) === String(id)){ viewedUser = me; renderProfile(); loadPosts(me.id); return; }
        throw new Error("User not found");
      }
      // merge server user with local user so avatar edits persist
      viewedUser = mergeAndStoreUser(found);
      renderProfile();
      await loadPosts(viewedUser.id);
      await loadFollowCounts(viewedUser.id);
    }catch(e){
      console.error("initProfile", e);
      document.getElementById("postsArea").innerHTML = "<div class='muted'>Could not load profile.</div>";
    }
  }

  function renderProfile(){
    document.getElementById("profileAvatar").src = viewedUser.avatar || DEFAULT_AV;
    document.getElementById("profileName").innerText = viewedUser.name || viewedUser.email || "User";
    document.getElementById("profileEmail").innerText = viewedUser.email || "";
    document.getElementById("profileBio").innerText = viewedUser.bio || "";

    if(String(me?.id) === String(viewedUser.id)){
      document.getElementById("editBtn").style.display = "inline-block";
      document.getElementById("followBtn").style.display = "none";
    } else {
      document.getElementById("editBtn").style.display = "none";
      document.getElementById("followBtn").style.display = "inline-block";
      setupFollowBtn();
    }
  }

  async function loadPosts(userId){
    const target = document.getElementById("postsArea");
    target.innerHTML = "<div class='muted'>Loading posts...</div>";
    // try fetch /allposts then filter by user
    try{
      const r = await fetch(API + "/allposts");
      if(!r.ok) { target.innerHTML = "<div class='muted'>No posts</div>"; return; }
      const all = await r.json();
      const posts = Array.isArray(all) ? all.filter(p => String(p.user_id ?? p.userId ?? p.user ?? "") === String(userId)) : [];
      if(posts.length === 0){ target.innerHTML = "<div class='muted'>No posts yet.</div>"; return; }
      posts.sort((a,b)=> new Date(b.created_at || b.createdAt || 0) - new Date(a.created_at || a.createdAt || 0));
      target.innerHTML = posts.map(p => `
        <div class="post-card" style="display:flex;gap:12px;align-items:flex-start">
          <img src="${esc(p.image_url || p.image || '')}" style="width:120px;height:120px;border-radius:10px;object-fit:cover">
          <div style="flex:1">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div><div style="font-weight:700">${esc(p.title || p.caption || '')}</div><div class="small muted">${new Date(p.created_at || p.createdAt || '').toLocaleString()}</div></div>
              <div>${ String(p.user_id ?? p.userId ?? p.user ?? "") === String(me?.id) ? `<button class="btn" style="color:#b00;background:#fff;border:1px solid #f1f1f1" onclick="deletePost('${esc(p.id)}')">Delete</button>` : '' }</div>
            </div>
            <div style="margin-top:10px">${esc(p.content || p.caption || '')}</div>
          </div>
        </div>
      `).join("");
    }catch(e){
      console.error("loadPosts", e);
      target.innerHTML = "<div class='muted'>Could not load posts</div>";
    }
  }

  async function deletePost(postId){
    if(!confirm("Delete this post?")) return;
    try{
      const r = await fetch(API + "/deletepost/" + encodeURIComponent(postId), { method: "DELETE" });
      if(!r.ok){ const t = await r.text().catch(()=>null); alert("Delete failed: " + (t || r.status)); return; }
      await loadPosts(viewedUser.id);
    }catch(e){ console.error("deletePost", e); alert("Network error deleting"); }
  }

  async function loadFollowCounts(userId){
    try{
      const r1 = await fetch(API + "/followers/" + encodeURIComponent(userId));
      const r2 = await fetch(API + "/following/" + encodeURIComponent(userId));
      const followers = r1.ok ? await r1.json() : [];
      const following = r2.ok ? await r2.json() : [];
      document.getElementById("followersNum").innerText = (followers && followers.length) ? followers.length : 0;
      document.getElementById("followingNum").innerText = (following && following.length) ? following.length : 0;
      document.getElementById("followersCount").onclick = ()=> showListModal("Followers", followers || []);
      document.getElementById("followingCount").onclick = ()=> showListModal("Following", following || []);
    }catch(e){ console.warn("loadFollowCounts", e); }
  }

  function showListModal(title, arr){
    document.getElementById("modalTitle").innerText = title;
    const list = document.getElementById("modalList"); list.innerHTML = "";
    if(!arr || arr.length === 0){ list.innerHTML = "<div class='muted'>No users</div>"; document.getElementById("modalBackdrop").style.display = "flex"; return; }
    arr.forEach(u=>{
      const row = document.createElement("div");
      row.style.display = "flex"; row.style.alignItems = "center"; row.style.gap = "10px"; row.style.padding = "8px"; row.style.cursor = "pointer";
      row.onclick = ()=> { location.href = "profile.html?id=" + encodeURIComponent(u.id); };
      row.innerHTML = `<img src="${esc(u.avatar || DEFAULT_AV)}" style="width:46px;height:46px;border-radius:8px;object-fit:cover"><div><div style="font-weight:700">${esc(u.name)}</div><div class="muted small">${esc(u.email||'')}</div></div>`;
      list.appendChild(row);
    });
    document.getElementById("modalBackdrop").style.display = "flex";
  }
  function closeModal(){ document.getElementById("modalBackdrop").style.display = "none"; }

  function setupFollowBtn(){
    const btn = document.getElementById("followBtn");
    const key = "following_" + me?.id;
    const map = JSON.parse(localStorage.getItem(key) || "{}");
    const isFollowing = !!map[String(viewedUser.id)];
    btn.className = isFollowing ? "btn follow-btn following" : "btn follow-btn";
    btn.innerText = isFollowing ? "Following" : "Follow";
    btn.onclick = ()=> toggleFollow(viewedUser.id, btn);
  }

  async function toggleFollow(targetId, btn){
    if(!me || !me.id) return alert("Log in to follow");
    const key = "following_" + me.id;
    let map = JSON.parse(localStorage.getItem(key) || "{}");
    const wasFollowing = !!map[targetId];
    if(wasFollowing) { delete map[targetId]; btn.classList.remove("following"); btn.innerText = "Follow"; }
    else { map[targetId] = true; btn.classList.add("following"); btn.innerText = "Following"; }
    localStorage.setItem(key, JSON.stringify(map));
    try{
      const url = wasFollowing ? API + "/unfollow" : API + "/follow";
      await fetch(url, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ follower_id: me.id, followee_id: targetId }) });
    }catch(e){ console.warn("follow api failed", e); }
    await loadFollowCounts(viewedUser.id);
  }

  function editProfile(){ location.href = "edit-profile.html?id=" + encodeURIComponent(viewedUser.id); }

  // respond to edit-profile changes
  window.addEventListener("storage", (evt)=>{
    if(evt.key === "user"){
      try { me = JSON.parse(evt.newValue || "null"); } catch(e){ me = null; }
      if(me && me.id) me.id = String(me.id);
      applyLocalUserToProfileUI();
      if(viewedUser && String(viewedUser.id) === String(me?.id)){
        // re-render to pick up latest avatar/name
        viewedUser = Object.assign({}, viewedUser, me);
        renderProfile();
      }
    }
  });

  // Start
  initProfile();

</script>

</body>
</html>
