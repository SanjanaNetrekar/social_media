<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Feed</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style> /* minimal inline CSS so you can copy-paste quickly */
    body{background:#f5f7fb;font-family:Arial, sans-serif;}
    .card{border-radius:10px}
    .tag{display:inline-block;background:#eef;padding:4px 8px;border-radius:12px;margin-right:6px;margin-top:6px}
  </style>
</head>
<body>
<nav class="navbar navbar-light bg-primary text-white p-3">
  <div class="container">
    <div><strong>Social Media</strong></div>
    <div>
      <a class="btn btn-sm btn-light me-2" href="/users">Users</a>
      <a class="btn btn-sm btn-light me-2" href="/tagspage">Tags</a>
      <button class="btn btn-sm btn-light" onclick="logout()">Logout</button>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <div class="card p-3 mb-4">
    <h5>Create Post</h5>
    <textarea id="content" class="form-control mb-2" placeholder="Write something..."></textarea>
    <input id="image" type="file" accept="image/*" class="form-control mb-2" />
    <input id="tagsInput" type="text" class="form-control mb-2" placeholder="Tags (comma separated) e.g. travel,food" />
    <button class="btn btn-primary w-100" onclick="createPost()">Post</button>
  </div>

  <div id="posts"></div>
</div>

<script>
const api = "http://localhost:3000";
const user = JSON.parse(localStorage.getItem("user"));
if (!user) location.href = "/"; // assume index has login/register

async function uploadImage(file){
  if (!file) return null;
  const fd = new FormData(); fd.append("image", file);
  const res = await fetch(api + "/upload", { method: "POST", body: fd });
  if (!res.ok) { alert("Upload failed"); return null; }
  const j = await res.json(); return j.url;
}

async function createPost(){
  const content = document.getElementById("content").value.trim();
  const file = document.getElementById("image").files[0];
  const tagsRaw = document.getElementById("tagsInput").value.trim();
  if (!content && !file) return alert("Write or attach an image");

  let image_url = null;
  if (file) image_url = await uploadImage(file);

  const body = { user_id: user.id, content, image_url, tags: tagsRaw || null };
  await fetch(api + "/addpost", { method: "POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
  document.getElementById("content").value = "";
  document.getElementById("image").value = "";
  document.getElementById("tagsInput").value = "";
  loadPosts();
}

async function loadPosts(){
  const res = await fetch(api + "/allposts");
  const posts = await res.json();
  const div = document.getElementById("posts"); div.innerHTML = "";
  for (const p of posts){
    const card = document.createElement("div"); card.className = "card p-3 mb-3";
    // follow button text: If post.user_id === current user => no follow button; else show Follow/Unfollow
    let followBtn = "";
    if (p.user_id !== user.id){
      followBtn = `<button class="btn btn-sm btn-outline-primary" onclick="toggleFollow(${p.user_id}, this)">Follow</button>`;
    }
    // tags display
    const tagsHtml = (p.tags || []).map(t => `<span class="tag">${t}</span>`).join("");

    card.innerHTML = `
      <div class="d-flex justify-content-between">
        <div><strong>${p.name}</strong><br><small class="text-muted">${new Date(p.created_at).toLocaleString()}</small></div>
        <div>${followBtn}</div>
      </div>
      <p class="mt-2">${p.content || ""}</p>
      ${p.image_url ? `<img src="${p.image_url}" style="max-width:100%; border-radius:8px; margin-bottom:8px;">` : ""}
      <div>${tagsHtml}</div>
      <div class="mt-2">
        <button class="btn btn-outline-danger btn-sm" onclick="like(${p.id})">‚ù§Ô∏è ${p.likes}</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="toggleComments(${p.id})">üí¨ ${p.comments}</button>
        ${p.user_id === user.id ? `<button class="btn btn-outline-dark btn-sm" onclick="deletePost(${p.id})">Delete</button>` : ""}
      </div>
      <div id="comments-${p.id}" style="display:none; margin-top:8px;"></div>
    `;
    div.appendChild(card);
  }
}

async function like(post_id){
  await fetch(api + "/like", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ post_id, user_id: user.id })});
  loadPosts();
}

async function toggleComments(postId){
  const el = document.getElementById("comments-" + postId);
  if (el.style.display === "block"){ el.style.display = "none"; return; }
  const res = await fetch(api + "/comments/" + postId);
  const comments = await res.json();
  el.innerHTML = `
    ${comments.map(c => `<div><b>${c.name}</b>: ${c.content}</div>`).join("")}
    <input id="comment-${postId}" class="form-control my-2" placeholder="Add comment">
    <button class="btn btn-sm btn-primary" onclick="addComment(${postId})">Comment</button>
  `;
  el.style.display = "block";
}

async function addComment(postId){
  const content = document.getElementById("comment-" + postId).value.trim();
  if (!content) return;
  await fetch(api + "/comment", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ post_id: postId, user_id: user.id, content })});
  toggleComments(postId);
  loadPosts();
}

async function deletePost(id){
  if (!confirm("Delete post?")) return;
  await fetch(api + "/deletepost/" + id, { method:"DELETE" });
  loadPosts();
}

async function toggleFollow(targetUserId, btn){
  // naive toggle: try follow then change label (could check following endpoint to make precise)
  await fetch(api + "/follow", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ follower_id: user.id, followee_id: targetUserId })});
  alert("Followed ‚Äî refresh to see data");
}

// logout
function logout(){ localStorage.removeItem("user"); location.href = "/"; }

// initial load
loadPosts();
</script>
</body>
</html>
