<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Feed â€¢ InstaLite</title>
  <link rel="stylesheet" href="style.css">
  <style>
    :root{ --muted:#7b7b7b; --accent1:linear-gradient(90deg,#06b6d4,#7c3aed); }
    body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto;margin:0;background:linear-gradient(180deg,#fbfbfd,#f6f2fb);}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:18px 24px;background:var(--accent1);color:#fff}
    .logo{font-weight:800;font-size:20px}
    .search{width:50%;max-width:720px}
    .search input{width:100%;padding:12px 16px;border-radius:999px;border:none;outline:none}
    .top-actions{display:flex;gap:12px;align-items:center}
    .main{display:flex;gap:22px;width:94%;margin:22px auto}
    .col{background:#fff;border-radius:14px;padding:16px;box-shadow:0 8px 30px rgba(20,20,40,0.06)}
    .left{width:23%}.center{width:54%}.right{width:23%}
    .profile-mini{display:flex;gap:12px;align-items:center}
    .profile-mini img{width:84px;height:84px;border-radius:12px;object-fit:cover;cursor:pointer}
    .post-create textarea{width:100%;height:70px;padding:12px;border-radius:10px;border:1px solid #f0f0f0;resize:none}
    .post-create .row{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
    .post-card{padding:14px;border-radius:12px;margin-top:14px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,0.03)}
    .post-card .meta{display:flex;gap:12px;align-items:flex-start}
    .post-card img.post-image{width:100%;margin-top:12px;border-radius:12px;object-fit:cover}
    .btn{padding:8px 14px;border-radius:12px;border:none;cursor:pointer}
    .follow-btn{background:#f0f0f0}
    .follow-btn.following{background:#111;color:#fff}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .post-actions{display:flex;gap:8px;margin-top:10px;align-items:center}
    .like-btn.liked{color:#e63946;font-weight:700}
    .empty-placeholder{min-height:260px;display:flex;align-items:center;justify-content:center;color:var(--muted)}
  </style>
</head>
<body>

  <div class="topbar">
    <div style="display:flex;align-items:center;gap:18px">
      <div class="logo">InstaLite</div>
      <button class="btn" onclick="location.href='users.html'">Users</button>
    </div>

    <div class="search"><input id="searchInput" placeholder="Search users by name or #tag..."></div>

    <div class="top-actions">
      <button class="btn" onclick="location.href='messages.html'">Messages</button>
      <img id="topAvatar" src="" style="width:44px;height:44px;border-radius:10px;object-fit:cover;cursor:pointer" title="My profile">
    </div>
  </div>

  <div class="main">
    <!-- LEFT -->
    <div class="col left">
      <div class="profile-mini">
        <img id="leftAvatar" src="">
        <div>
          <div id="leftName" style="font-weight:700"></div>
          <div id="leftEmail" class="muted"></div>
          <div style="margin-top:10px"><button class="btn" onclick="goToProfileId(me?.id)">View Profile</button></div>
        </div>
      </div>

      <div style="margin-top:14px">
        <div style="font-weight:700;margin-bottom:8px">Stories</div>
        <div><button class="btn" onclick="alert('Stories coming soon')">+ Add Story</button></div>
      </div>
    </div>

    <!-- CENTER -->
    <div class="col center">
      <div class="post-create" style="background:linear-gradient(180deg,#fff,#fff);">
        <textarea id="postText" placeholder="Share something awesome..."></textarea>
        <div class="row" style="display:flex;align-items:center;justify-content:space-between">
          <div><input type="file" id="postFile" accept="image/*"></div>
          <div><button class="btn" style="background:linear-gradient(90deg,#06b6d4,#7c3aed);color:#fff" onclick="createPost()">Post</button></div>
        </div>
      </div>

      <div id="feedList" class="empty-placeholder">Loading posts...</div>
    </div>

    <!-- RIGHT -->
    <div class="col right">
      <div style="font-weight:700;margin-bottom:10px">Suggestions</div>
      <div id="suggestionList"></div>

      <div style="margin-top:18px">
        <div style="font-weight:700;margin-bottom:8px">Trending tags</div>
        <div id="tagsBox" class="muted">No trending tags</div>
      </div>
    </div>
  </div>

<script>
  // ========== CONFIG & STATE ==========
  const API = "http://localhost:3000";
  const DEFAULT_AV = "/uploads/default-avatar.png";

  // reactive local user (read from localStorage; updated when edit-profile writes)
  let me = null;
  try { me = JSON.parse(localStorage.getItem("user") || "null"); } catch(e){ me = null; }
  if(me && me.id) me.id = String(me.id);

  // update UI from local me
  function applyLocalUserToFeedUI(){
    const topAv = document.getElementById("topAvatar");
    const leftAv = document.getElementById("leftAvatar");
    const leftName = document.getElementById("leftName");
    const leftEmail = document.getElementById("leftEmail");
    if(me){
      topAv.src = me.avatar || DEFAULT_AV;
      leftAv.src = me.avatar || DEFAULT_AV;
      leftName.innerText = me.name || me.email || "Me";
      leftEmail.innerText = me.email || "";
      topAv.onclick = ()=> goToProfileId(me.id);
    } else {
      topAv.src = DEFAULT_AV;
      leftAv.src = DEFAULT_AV;
      leftName.innerText = "Guest";
      leftEmail.innerText = "";
    }
  }

  applyLocalUserToFeedUI();

  // respond to changes other tabs/pages make to localStorage.user
  window.addEventListener("storage", (evt)=>{
    if(evt.key === "user"){
      try { me = JSON.parse(evt.newValue || "null"); } catch(e){ me = null; }
      if(me && me.id) me.id = String(me.id);
      applyLocalUserToFeedUI();
      // optionally refresh feed metadata
      // loadFeed();
    }
  });

  // ========== HELPERS ==========
  const el = id => document.getElementById(id);
  const esc = s => { if(s===null||s===undefined) return ""; return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function goToProfileId(id){ if(!id) return alert("Profile id missing"); location.href = "profile.html?id=" + encodeURIComponent(String(id)); }

  // ========== LOAD POSTS (server uses /allposts) ==========
  async function loadFeed(){
    el("feedList").classList.add("empty-placeholder");
    el("feedList").innerText = "Loading posts...";
    try{
      const r = await fetch(API + "/allposts");
      if(!r.ok){
        el("feedList").classList.remove("empty-placeholder");
        el("feedList").innerHTML = "<div class='muted'>Could not load posts (status " + r.status + ")</div>";
        return;
      }
      const posts = await r.json();
      if(!Array.isArray(posts) || posts.length === 0){
        el("feedList").classList.remove("empty-placeholder");
        el("feedList").innerHTML = "<div class='muted'>No posts available.</div>";
        return;
      }
      posts.sort((a,b)=> new Date(b.created_at || b.createdAt || 0) - new Date(a.created_at || a.createdAt || 0));
      el("feedList").classList.remove("empty-placeholder");
      el("feedList").innerHTML = posts.map(renderPost).join("");
      refreshLikeButtons();
    }catch(err){
      console.error("loadFeed", err);
      el("feedList").classList.remove("empty-placeholder");
      el("feedList").innerHTML = "<div class='muted'>Network error while loading posts.</div>";
    }
  }

  function renderPost(p){
    const authorId = String(p.user_id ?? p.userId ?? p.user ?? "");
    const postId = p.id ?? p.post_id ?? "";
    const image = p.image_url ?? "";
    const created = p.created_at ?? p.createdAt ?? "";
    return `
      <div class="post-card" data-post-id="${esc(postId)}" data-author-id="${esc(authorId)}">
        <div class="meta">
          <img src="${esc(p.avatar || DEFAULT_AV)}" style="width:56px;height:56px;border-radius:10px;object-fit:cover;cursor:pointer" onclick="goToProfileId('${esc(authorId)}')">
          <div style="flex:1">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div>
                <div onclick="goToProfileId('${esc(authorId)}')" style="font-weight:700;cursor:pointer">${esc(p.name || p.username || 'Unknown')}</div>
                <div class="small">${new Date(created).toLocaleString()}</div>
              </div>
              <div style="text-align:right">
                ${authorId === me?.id ? `<button class="btn" style="background:#fff;border:1px solid #f1f1f1;color:#b00" onclick="deletePost('${esc(postId)}')">Delete</button>` : `<button class="btn follow-btn" onclick="toggleFollow('${esc(authorId)}', this)">Follow</button>`}
              </div>
            </div>
            <div style="margin-top:10px">${esc(p.content || p.body || "")}</div>
            ${image ? `<img class="post-image" src="${esc(image)}">` : ""}
            <div class="post-actions">
              <button class="btn like-btn" onclick="toggleLike('${esc(postId)}', this)">â™¡ Like</button>
              <button class="btn" onclick="openCommentPrompt('${esc(postId)}')">ðŸ’¬ Comment</button>
              <button class="btn" onclick="sharePost('${esc(postId)}')">ðŸ”— Share</button>
            </div>
            <div class="small muted" id="meta-${esc(postId)}">${(p.likes || 0)} likes Â· ${(p.comments || 0)} comments</div>
          </div>
        </div>
      </div>
    `;
  }

  // ========== CREATE POST (upload -> addpost) ==========
  async function createPost(){
    if(!me || !me.id){ alert("Please log in to post."); return; }
    const content = el("postText").value.trim();
    const file = el("postFile").files[0];
    if(!content && !file) return alert("Write something or choose an image.");

    try{
      let image_url = null;
      if(file){
        const fd = new FormData();
        fd.append("image", file);
        if(me && me.id) fd.append("user_id", me.id);
        const up = await fetch(API + "/upload", { method: "POST", body: fd });
        const upJson = await up.json().catch(()=>null);
        if(!up.ok){
          const err = upJson && (upJson.message || JSON.stringify(upJson)) ? (upJson.message || JSON.stringify(upJson)) : ("Upload failed (status " + up.status + ")");
          alert("Image upload failed: " + err);
          console.error("upload error", up.status, upJson);
          return;
        }
        image_url = upJson && (upJson.url || upJson.path) ? (upJson.url || upJson.path) : null;
      }

      const payload = { user_id: me.id, content: content || "", image_url: image_url };
      const add = await fetch(API + "/addpost", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload) });
      const addJson = await add.json().catch(()=>null);
      if(!add.ok){
        const msg = addJson && (addJson.message || JSON.stringify(addJson)) ? (addJson.message || JSON.stringify(addJson)) : ("Add post failed (status " + add.status + ")");
        alert("Create post failed: " + msg);
        console.error("addpost error", add.status, addJson);
        return;
      }
      el("postText").value = ""; el("postFile").value = "";
      await loadFeed();
    }catch(e){
      console.error("createPost exception", e);
      alert("Network error creating post: " + (e && e.message ? e.message : e));
    }
  }

  // ========== DELETE POST ==========
  async function deletePost(postId){
    if(!confirm("Delete this post?")) return;
    try{
      const r = await fetch(API + "/deletepost/" + encodeURIComponent(postId), { method: "DELETE" });
      if(!r.ok){ const t = await r.text().catch(()=>null); alert("Delete failed: " + (t || r.status)); return; }
      await loadFeed();
    }catch(e){ console.error("deletePost", e); alert("Network error deleting post"); }
  }

  // ========== LIKE ==========
  async function toggleLike(postId, btn){
    if(!me || !me.id) return alert("Log in to like posts");
    try{
      const r = await fetch(API + "/like", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ post_id: postId, user_id: me.id }) });
      const j = await r.json().catch(()=>null);
      if(!r.ok) return alert("Like failed: " + (j && j.message ? j.message : r.status));
      await loadFeed();
    }catch(e){ console.error("like error", e); alert("Network error liking post"); }
  }

  // ========== COMMENTS ==========
  async function openCommentPrompt(postId){
    if(!me || !me.id) return alert("Log in to comment");
    const text = prompt("Write a comment:");
    if(!text) return;
    try{
      const r = await fetch(API + "/comment", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ post_id: postId, user_id: me.id, content: text }) });
      const j = await r.json().catch(()=>null);
      if(!r.ok) return alert("Comment failed: " + (j && j.message ? j.message : r.status));
      await loadFeed();
    }catch(e){ console.error("comment error", e); alert("Network error posting comment"); }
  }

  // ========== SHARE ==========
  function sharePost(postId){
    const url = location.origin + "/profile.html?post=" + encodeURIComponent(postId);
    navigator.clipboard?.writeText(url).then(()=> alert("Link copied to clipboard"), ()=> alert("Copy failed â€” link: " + url));
  }

  // ========== FOLLOW / SUGGESTIONS / SEARCH ==========
  async function toggleFollow(targetId, btn){
    if(!me || !me.id) return alert("Log in to follow");
    const key = "following_" + me.id;
    let map = JSON.parse(localStorage.getItem(key) || "{}");
    const isFollowing = !!map[targetId];
    if(isFollowing){ delete map[targetId]; btn.classList.remove("following"); btn.innerText = "Follow"; }
    else { map[targetId] = true; btn.classList.add("following"); btn.innerText = "Following"; }
    localStorage.setItem(key, JSON.stringify(map));
    try{
      const url = isFollowing ? API + "/unfollow" : API + "/follow";
      await fetch(url, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ follower_id: me.id, followee_id: targetId }) });
    }catch(e){ console.warn("follow API failed", e); }
  }

  el("searchInput").addEventListener("keydown", async (ev)=>{
    if(ev.key !== "Enter") return;
    const q = el("searchInput").value.trim().toLowerCase();
    if(!q) return;
    try{
      const r = await fetch(API + "/users");
      if(!r.ok) return alert("Search failed (server)");
      const arr = await r.json();
      const found = arr.find(u => (u.name || "").toLowerCase().includes(q) || String(u.id) === q);
      if(found) goToProfileId(found.id);
      else alert("No user matched");
    }catch(e){ console.error("search error", e); alert("Search failed"); }
  });

  async function loadSuggestions(){
    try{
      const r = await fetch(API + "/users");
      if(!r.ok){ el("suggestionList").innerHTML = "<div class='muted'>Could not load</div>"; return; }
      const users = await r.json();
      el("suggestionList").innerHTML = users.filter(u => String(u.id) !== String(me?.id)).map(u => `
        <div class="suggest-row">
          <div style="display:flex;gap:10px;align-items:center;cursor:pointer" onclick="goToProfileId('${esc(u.id)}')">
            <img src="${esc(u.avatar || DEFAULT_AV)}" style="width:45px;height:45px;border-radius:10px;object-fit:cover">
            <div><div style="font-weight:700">${esc(u.name)}</div><div class="muted small">${esc(u.email)}</div></div>
          </div>
          <div><button class="btn follow-btn" onclick="toggleFollow('${esc(u.id)}', this)">Follow</button></div>
        </div>
      `).join("");
    }catch(e){ console.warn("suggestions error", e); el("suggestionList").innerHTML = "<div class='muted'>Error</div>"; }
  }

  function refreshLikeButtons(){ /* no-op; feed reload updates meta */ }

  // ========== BOOT ==========
  loadFeed();
  loadSuggestions();

</script>
</body>
</html>
