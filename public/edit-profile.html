<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><title>Edit profile • InstaLite</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css">
  <style>
    body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto;margin:0;background:linear-gradient(180deg,#fbfbfd,#f6f2fb)}
    .container{width:92%;margin:22px auto;display:flex;gap:22px}
    .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(20,20,40,0.06)}
    .pv img{width:120px;height:120px;border-radius:12px;object-fit:cover}
    .input{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  </style>
</head>
<body>

  <div class="topbar" style="display:flex;align-items:center;justify-content:space-between;padding:18px 28px;background:linear-gradient(90deg,#06b6d4,#7c3aed);color:#fff">
    <div style="font-weight:700">InstaLite</div>
    <div style="display:flex;gap:10px;align-items:center">
      <button class="btn" onclick="location.href='feed.html'">Feed</button>
      <button class="btn" onclick="location.href='users.html'">Users</button>
    </div>
  </div>

  <div class="container">
    <div class="left card">
      <div style="font-weight:700;margin-bottom:8px">Edit Profile</div>
      <div class="pv">
        <img id="preview" src="" alt="avatar preview">
        <div>
          <div id="displayName" style="font-weight:700"></div>
          <div id="displayEmail" class="muted"></div>
        </div>
      </div>

      <div class="form-row">
        <label for="file">Choose avatar</label><br>
        <input id="file" type="file" accept="image/*">
        <div style="margin-top:8px">
          <button id="uploadBtn" class="btn" style="background:linear-gradient(90deg,#06b6d4,#7c3aed);color:#fff">Upload avatar</button>
        </div>
      </div>
    </div>

    <div class="right card">
      <div style="font-weight:700">Profile details</div>

      <div class="form-row">
        <label for="name">Name</label><br>
        <input id="name" class="input" placeholder="Your name">
      </div>

      <div class="form-row">
        <label for="bio">Bio</label><br>
        <textarea id="bio" class="input" rows="4" placeholder="A short bio."></textarea>
      </div>

      <div class="form-row" style="margin-top:14px">
        <button id="save" class="btn" style="background:#06b6d4;color:#fff">Save</button>
        <button id="cancel" class="btn" style="margin-left:8px" onclick="location.href='profile.html?id=' + (me && me.id ? encodeURIComponent(me.id) : '')">Cancel</button>
      </div>
    </div>
  </div>

<script>
  const API = "http://localhost:3000";
  let me = null;
  try { me = JSON.parse(localStorage.getItem('user') || 'null'); if(me && me.id) me.id = String(me.id); } catch(e){ me = null; }

  const preview = document.getElementById('preview');
  const nameInput = document.getElementById('name');
  const bioInput = document.getElementById('bio');
  const displayName = document.getElementById('displayName');
  const displayEmail = document.getElementById('displayEmail');

  function initUI(){
    if(!me){
      displayName.innerText = 'Not logged in';
      displayEmail.innerText = '';
      preview.src = '/uploads/default-avatar.png';
      return;
    }
    displayName.innerText = me.name || me.email || 'You';
    displayEmail.innerText = me.email || '';
    preview.src = me.avatar || me.image_url || '/uploads/default-avatar.png';
    nameInput.value = me.name || '';
    bioInput.value = me.bio || '';
  }

  initUI();

  // Upload handler
  document.getElementById('uploadBtn').addEventListener('click', async ()=>{
    const file = document.getElementById('file').files[0];
    if(!file) return alert('Choose an image to upload');
    const fd = new FormData(); fd.append('image', file); fd.append('user_id', me && me.id ? me.id : '');
    try{
      const r = await fetch(API + '/upload', { method:'POST', body: fd });
      if(!r.ok) throw new Error('Upload failed');
      const j = await r.json();
      const url = j.url || j.path || j.filename || (j.data && j.data.url) || null;
      if(url){
        preview.src = url;
        me.avatar = url;
        localStorage.setItem('user', JSON.stringify(me));
        alert('Avatar updated locally');
      } else alert('Upload returned no url');
    }catch(e){ console.warn(e); alert('Upload failed'); }
  });

  // Save handler — optimistic local + server update if available
  document.getElementById('save').addEventListener('click', async ()=>{
    const newName = nameInput.value.trim();
    const newBio = bioInput.value.trim();
    if(!newName) return alert('Enter a name');

    if(!me) me = {};
    me.name = newName;
    me.bio = newBio;
    try{ localStorage.setItem('user', JSON.stringify(me)); }catch(e){}
    // Build payload
    const payload = { name: newName, bio: newBio, avatar: me.avatar || null };

    try{
      if(me && me.id){
        // try PUT /user/:id (some servers may accept)
        const putResp = await fetch(API + '/user/' + encodeURIComponent(me.id), {
          method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        if(putResp.ok){
          const putJson = await putResp.json().catch(()=>null);
          let returnedUser = null;
          if(putJson){ if(putJson.user) returnedUser = putJson.user; else if(putJson.id || putJson.email) returnedUser = putJson; }
          if(returnedUser){ localStorage.setItem('user', JSON.stringify(returnedUser)); me = returnedUser; }
          alert('Profile updated');
          location.href = 'profile.html?id=' + encodeURIComponent(me.id);
          return;
        }
      }

      // fallback endpoint (some servers use updateUser)
      const postResp = await fetch(API + '/updateUser', {
        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(Object.assign({ id: me && me.id ? me.id : null }, payload))
      });
      if(postResp.ok){
        const pj = await postResp.json().catch(()=>null);
        if(pj && pj.user){ localStorage.setItem('user', JSON.stringify(pj.user)); me = pj.user; }
        alert('Profile updated');
        location.href = 'profile.html?id=' + encodeURIComponent(me.id);
        return;
      }

      const txt = await (postResp && postResp.text ? postResp.text().catch(()=>null) : null);
      throw new Error('Server update failed' + (txt ? (': ' + txt) : ''));
    }catch(e){
      console.warn('profile save failed', e);
      localStorage.setItem('user', JSON.stringify(me));
      alert('Saved locally (server update failed). Redirecting to profile.');
      location.href = 'profile.html?id=' + encodeURIComponent(me.id);
    }
  });
</script>
</body>
</html>
