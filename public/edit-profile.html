<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><title>Edit profile</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css">
  <style>.avatar-lg{width:120px;height:120px;border-radius:14px;object-fit:cover}.muted{color:#666}.card{background:#fff;padding:16px;border-radius:12px}</style>
</head>
<body>
<main style="max-width:720px;margin:24px auto;padding:12px">
  <div class="card">
    <h2>Edit profile</h2>
    <div id="status">Loading…</div>
    <div id="form" style="display:none">
      <div style="display:flex;gap:16px;align-items:center">
        <img id="preview" class="avatar-lg" src="">
        <div>
          <input id="file" type="file" accept="image/*"><br><br>
          <button id="uploadBtn" class="btn">Upload avatar</button>
        </div>
      </div>
      <div style="margin-top:12px">
        <label>Full name<br><input id="name" class="input"></label>
      </div>
      <div style="margin-top:12px">
        <label>Bio<br><textarea id="bio" class="input" rows="3"></textarea></label>
      </div>
      <div style="margin-top:12px"><button id="save" class="btn gradient">Save</button></div>
    </div>
  </div>
</main>

<script>
const API = 'http://localhost:3000';
const DEFAULT_AV = '/mnt/data/a2ec838d-f32b-43e1-8b47-ff7434b1674c.png';
let me = null;
try{ me = JSON.parse(localStorage.getItem('user') || 'null'); }catch(e){ me = null; }

function q(name){ return new URL(location.href).searchParams.get(name); }

(async function init(){
  const id = q('id');
  if(!id){ document.getElementById('status').innerText = 'Missing id'; return; }
  if(!me){ document.getElementById('status').innerText = 'Please log in'; return; }
  if(String(me.id) !== String(id)){ document.getElementById('status').innerText = 'You cannot edit this profile'; setTimeout(()=>location.href='profile.html?id='+id,800); return; }

  // Populate form from localStorage user (fast)
  document.getElementById('preview').src = me.avatar || DEFAULT_AV;
  document.getElementById('name').value = me.name || '';
  document.getElementById('bio').value = me.bio || '';
  document.getElementById('form').style.display = 'block';
  document.getElementById('status').style.display = 'none';

  document.getElementById('uploadBtn').addEventListener('click', async ()=>{
    const file = document.getElementById('file').files[0];
    if(!file) return alert('Choose an image');
    const fd = new FormData(); fd.append('image', file); fd.append('user_id', me.id);
    try{
      const r = await fetch(API + '/upload', { method:'POST', body: fd });
      if(!r.ok) throw new Error('Upload failed');
      const j = await r.json();
      const url = j.url || j.path || j.filename || (j.data && j.data.url) || null;
      if(url) {
        document.getElementById('preview').src = url;
        me.avatar = url;
        localStorage.setItem('user', JSON.stringify(me));
        alert('Avatar updated locally');
      } else alert('Upload returned no url');
    }catch(e){ alert('Upload failed'); console.warn(e); }
  });

  document.getElementById('save').addEventListener('click', async ()=>{
    const name = document.getElementById('name').value.trim();
    const bio = document.getElementById('bio').value.trim();
    if(!name) return alert('Enter name');

    // Update localStorage (optimistic)
    me.name = name; me.bio = bio;
    localStorage.setItem('user', JSON.stringify(me));
    // also set a simple flag so other tabs/pages know we've updated profile
    try{ localStorage.setItem('profile_updated_at', Date.now()); }catch(e){}

    // Preferred: try PUT /user/:id; fallback to POST /updateUser
    const payload = { name, bio, avatar: me.avatar };
    try {
      const putRes = await fetch(API + '/user/' + encodeURIComponent(me.id), {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!putRes.ok) {
        // fallback
        const p2 = await fetch(API + '/updateUser', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(Object.assign({ id: me.id }, payload))
        });
        if (!p2.ok) throw new Error('Server update failed');
      }
      alert('Profile updated');
    } catch (e) {
      console.warn('update failed', e);
      alert('Saved locally (server update failed)');
    }

    // Redirect back to profile — profile page listens to localStorage changes and will refresh
    location.href = 'profile.html?id=' + encodeURIComponent(me.id);
  });
})();
</script>
</body>
</html>
