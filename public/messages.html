<!DOCTYPE html>
<html><head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Messages</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head><body class="p-4">
  <a href="feed.html">‚Üê Feed</a>
  <h3 id="chatWith">Chat</h3>
  <div id="messages" style="height:400px; overflow:auto; border:1px solid #ddd; padding:8px; margin-bottom:8px;"></div>

  <div class="d-flex gap-2">
    <input id="msgInput" class="form-control" placeholder="Write a message">
    <button class="btn btn-primary" onclick="sendMsg()">Send</button>
  </div>

<script>
const api = "http://localhost:3000";
const user = JSON.parse(localStorage.getItem("user"));
const chatWith = JSON.parse(localStorage.getItem("chatWith") || "null");
if (!user) location.href="index.html";
if (!chatWith) { document.getElementById("chatWith").innerText = "Select a user from Users page"; }

async function loadMessages() {
  if (!chatWith) return;
  document.getElementById("chatWith").innerText = `Chat with ${chatWith.name}`;
  const res = await fetch(`${api}/messages/${user.id}/${chatWith.id}`);
  const msgs = await res.json();
  const box = document.getElementById("messages");
  box.innerHTML = msgs.map(m => `<div><b>${m.sender_name}</b>: ${m.content || ''} ${m.image_url ? `<br><img src="${m.image_url}" style="max-width:200px" />` : ''}</div>`).join("<hr>");
  box.scrollTop = box.scrollHeight;
}

async function sendMsg() {
  if (!chatWith) return alert("Pick a user to chat with");
  const content = document.getElementById("msgInput").value.trim();
  if (!content) return;
  await fetch(`${api}/message`, {
    method: "POST", headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ sender_id: user.id, receiver_id: chatWith.id, content })
  });
  document.getElementById("msgInput").value = "";
  loadMessages();
}

loadMessages();
setInterval(loadMessages, 3000); // refresh every 3s
</script>
</body></html>
