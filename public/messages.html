<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Messages â€¢ InstaLite</title><link rel="stylesheet" href="style.css"><script src="/socket.io/socket.io.js" defer></script></head>
<body>
<header class="topbar small"><div class="top-inner"><div class="left"><div class="logo-square">IL</div><div class="app-title">InstaLite</div></div><div class="right"><button class="icon" onclick="location.href='feed.html'">Feed</button></div></div></header>

<main class="messages-wrap" style="max-width:1200px;margin:18px auto;">
  <aside class="users-list card" style="min-height:520px;overflow:auto;">
    <div style="font-weight:800;margin-bottom:12px">Chats</div>
    <div id="usersList"></div>
  </aside>

  <section class="chat-area card" style="display:flex;flex-direction:column;min-height:520px;">
    <div id="chatHeader" class="chat-header"><img id="chatAvatar" class="avatar-sm" src="/mnt/data/a2ec838d-f32b-43e1-8b47-ff7434b1674c.png" style="width:56px;height:56px"><div style="flex:1"><div id="chatName" style="font-weight:800">Select a chat</div><div id="typingIndicator" class="small muted"></div></div></div>
    <div id="messagesWrap" class="chat-messages" style="flex:1;overflow:auto;padding:18px"></div>
    <div class="chat-input" style="display:flex;gap:10px;align-items:center;padding:12px;border-top:1px solid rgba(11,22,40,0.04)"><input id="msgInput" class="input" placeholder="Write a message..." style="flex:1"><input id="msgFile" type="file" accept="image/*" style="display:none"><button class="btn ghost" onclick="document.getElementById('msgFile').click()">ðŸ“·</button><button class="btn gradient" id="sendBtn">Send</button></div>
  </section>
</main>

<script>
const API = 'http://localhost:3000';
const me = JSON.parse(localStorage.getItem('user'));
if(!me) location.href='index.html';
let currentChat = JSON.parse(localStorage.getItem('chatWith') || 'null');

const socket = (typeof io==='function')?io():null;
if(socket && socket.emit) socket.emit('register', me.id);
if(socket && socket.on){
  socket.on('private_message', msg => {
    if(currentChat && (msg.sender_id === currentChat.id || msg.receiver_id === currentChat.id)) appendMessage(msg);
    else showToast(`${msg.sender_name || 'Someone'} sent a message`);
  });
  socket.on('typing', ({from}) => { if(currentChat && currentChat.id===from){ document.getElementById('typingIndicator').innerText = currentChat.name + ' is typing...'; clearTimeout(window._t); window._t=setTimeout(()=>document.getElementById('typingIndicator').innerText='',1500); }});
}

async function loadUsers(){
  try{
    const r = await fetch(API + '/users'); if(!r.ok) return;
    const users = await r.json();
    const wrap = document.getElementById('usersList'); wrap.innerHTML = '';
    users.forEach(u => { if(u.id===me.id) return;
      const avatar = u.avatar || '/mnt/data/a2ec838d-f32b-43e1-8b47-ff7434b1674c.png';
      const node = document.createElement('div'); node.className='user-row'; node.style.display='flex'; node.style.gap='12px'; node.style.alignItems='center'; node.style.padding='10px'; node.style.cursor='pointer';
      node.onclick = ()=> startChat(u.id,u.name, u.avatar);
      node.innerHTML = `<img src="${avatar}" style="width:48px;height:48px;border-radius:10px;object-fit:cover"><div style="flex:1"><div style="font-weight:700">${escapeHtml(u.name||u.email)}</div><div class="small muted">${escapeHtml(u.email||'')}</div></div>`;
      wrap.appendChild(node);
    });
  }catch(e){ console.error(e); }
}

async function startChat(id, name, avatar){
  currentChat = { id, name, avatar };
  localStorage.setItem('chatWith', JSON.stringify(currentChat));
  await loadChat();
}

async function loadChat(){
  const headerName = document.getElementById('chatName'); const avatarEl = document.getElementById('chatAvatar'); const wrap = document.getElementById('messagesWrap');
  if(!currentChat){ headerName.innerText='Select a chat'; wrap.innerHTML=''; return; }
  headerName.innerText = currentChat.name; avatarEl.src = currentChat.avatar || '/mnt/data/a2ec838d-f32b-43e1-8b47-ff7434b1674c.png';
  try{
    const r = await fetch(API + `/messages/${me.id}/${currentChat.id}`); if(!r.ok){ wrap.innerHTML='<div class="muted">No conversation</div>'; return; }
    const msgs = await r.json(); wrap.innerHTML = ''; (msgs||[]).forEach(m=>appendMessage(m)); wrap.scrollTop = wrap.scrollHeight;
  }catch(e){ console.error(e); wrap.innerHTML='<div class="muted">Error loading messages</div>'; }
}

function appendMessage(msg){
  const wrap = document.getElementById('messagesWrap');
  const mine = (msg.sender_id === me.id || msg.senderId === me.id);
  const cont = document.createElement('div'); cont.style.display='flex'; cont.style.justifyContent = mine ? 'flex-end' : 'flex-start';
  const bubble = document.createElement('div'); bubble.className = mine ? 'bubble me' : 'bubble them';
  bubble.innerHTML = `${escapeHtml(msg.content||'')}${msg.image_url?`<div style="margin-top:8px"><img src="${msg.image_url}" style="max-width:260px;border-radius:10px"></div>`:''}<div class="small muted" style="margin-top:6px">${new Date(msg.created_at||msg.createdAt||Date.now()).toLocaleTimeString()}</div>`;
  cont.appendChild(bubble); wrap.appendChild(cont); wrap.scrollTop = wrap.scrollHeight;
}

document.getElementById('msgInput').addEventListener('input', ()=>{ if(!currentChat) return; if(socket && socket.emit) socket.emit('typing',{from:me.id,to:currentChat.id}); });

document.getElementById('sendBtn').addEventListener('click', async ()=>{
  if(!currentChat) return alert('Select a chat first');
  const content = document.getElementById('msgInput').value.trim();
  const file = document.getElementById('msgFile').files[0];
  let image_url = null;
  if(file){ const fd=new FormData(); fd.append('image',file); const r = await fetch(API + '/upload', { method:'POST', body: fd }); if(!r.ok) return alert('Image upload failed'); image_url = (await r.json()).url; }
  if(!content && !image_url) return;
  if(socket && socket.emit) socket.emit('send_message', { sender_id: me.id, receiver_id: currentChat.id, content, image_url });
  await fetch(API + '/message', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sender_id: me.id, receiver_id: currentChat.id, content, image_url })});
  appendMessage({ sender_id: me.id, content, image_url, created_at: new Date().toISOString() });
  document.getElementById('msgInput').value=''; document.getElementById('msgFile').value='';
});

function showToast(text){ const t=document.createElement('div'); t.className='toast'; t.innerText=text; document.body.appendChild(t); setTimeout(()=>t.remove(),3000); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

loadUsers();
if(currentChat) loadChat();
</script>
</body>
</html>
